# GitHub Copilot Instructions for ffire

## Architecture Overview

ffire is a binary serialization format with code generators for multiple languages.

### Language Tiers

| Tier | Languages | Implementation |
|------|-----------|----------------|
| **Tier 0** | Go | Native reference implementation |
| **Tier A** | C++, Rust, Swift, Zig, Java, C# | Native implementations (no FFI) |
| **Tier B** | Dart | FFI to C ABI (could be native with AOT) |
| **igniffi** | Python, JS, PHP, Ruby | TODO: C ABI + thin FFI wrappers |

**Note:** Java (ByteBuffer) and C# (Span<byte>) are native - they don't call C code.

### Project Structure

```
pkg/generator/           # Code generators
  generator_go.go        # Reference implementation
  generator_cpp.go       
  generator_swift.go     # Native Swift (UnsafeRawPointer)
  generator_dart.go      # FFI to C ABI (Tier B)
  generator_rust.go
  generator_zig.go
  generator_java.go      # Native Java (ByteBuffer)
  generator_csharp.go    # Native C# (Span<byte>)
  generator_c_abi.go     # C ABI for Dart + igniffi

pkg/benchmark/           # Benchmark generators
benchmarks/magefile.go   # Build coordinator
testdata/schema/         # Test schemas (.ffi files)
testdata/json/           # Test fixtures (.json files)
```

### Naming Conventions

**Message Suffix Rule:**
```
User writes:   type Config struct { ... }
Generated:     class ConfigMessage  (ALL languages)
C ABI funcs:   config_decode()     (lowercase, no suffix)
```

**Package Naming:**
```
File: struct.ffi
Declares: package test
Import: test (NOT struct)
Library: libtest.dylib (NOT libstruct.dylib)
```

### Build Commands

```bash
# From benchmarks/ directory
mage genAll           # Generate all languages × all schemas
mage gen go           # Generate only Go
mage run go           # Run Go benchmarks
mage bench            # Full: generate + run + compare
```

### Current Generator Status

| Language | Status | Notes |
|----------|--------|-------|
| Go | ✅ 10/10 | Reference implementation |
| C++ | ✅ 10/10 | Native with C ABI |
| Swift | ✅ 10/10 | Native UnsafeRawPointer |
| Rust | ✅ 10/10 | Native implementation |
| Zig | ✅ 10/10 | Native implementation |
| Java | ✅ 10/10 | Native (ByteBuffer) |
| C# | ✅ 10/10 | Native (Span<byte>) |
| Dart | ✅ 10/10 | FFI to C ABI |

### Removed Generators

- **Python pure** - Removed (too slow, use igniffi instead)
- **JavaScript pure** - Removed (encode slower than JSON.stringify)

These will be replaced by igniffi: a C ABI with thin FFI wrappers (koffi for JS, cffi for Python).

## Red Flags

Stop and check if you see:
- Class without `Message` suffix → Should be `ConfigMessage`, not `Config`
- Using filename instead of `schema.Package` → Use package name from schema
- C ABI with Message suffix → Should be `config_decode`, not `configmessage_decode`
- Referencing Python/JavaScript generators → They were removed

## Key Files

- `pkg/schema/schema.go` - Schema AST definitions
- `pkg/parser/parser.go` - .ffi file parser  
- `wire-format.md` - Binary wire format specification
- `docs/` - Full documentation
